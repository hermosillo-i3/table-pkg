image: node:latest

# This folder is cached between builds
# http://docs.gitlab.com/ce/ci/yaml/README.html#cache
cache:
  paths:
    - node_modules/

before_script:  
  - apt-get update
  - apt -y install python2

stages:
  - install
  - setup
  - pages
  - deploy

install:
  stage: install
  script:
    - npm install --no-progress  --legacy-peer-deps

setup:
  stage: setup
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths: 
      - node_modules/
  artifacts:
    paths:
      - node_modules/
  script:
    - npm


storybook:
  stage: setup
  artifacts:
    expire_in: 2 weeks
    when: always
    paths:
      - storybook/
  script:
    - npm run build-storybook

# stage: deployment (here I deploy my app to specific stages or other artefacts like storybook)

deploy-storybook:
  stage: deploy
  script:
    - echo "Enjoy the day. ðŸ¥³ Every job needs a script, but this job was just created to configure an environment."
  environment:
    name: storybook/$CI_COMMIT_REF_SLUG
    url: https://hermosilloi3.gitlab.io/custom-table/$CI_COMMIT_REF_SLUG/storybook/
    on_stop: remove STORYBOOK
  only:
    - branches

remove-storybook:
  stage: deploy
  cache:
    key: 'my-storybook'
    paths:
      - public
  script:
    - rm -rf "public/$CI_COMMIT_REF_SLUG/storybook"
  when: manual
  variables:
    GIT_STRATEGY: none # needed to prevent "Couldn't find remote ref" error
  environment:
    name: storybook/$CI_COMMIT_REF_SLUG
    action: stop

deploy:
  stage: deploy
  script:
    - yarn build-gitlab
    - cd dist
    - echo "//${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}">.npmrc
    - npm publish
    - cd ..

# stage: pages (the stage name is custom, but the job NEEDS to be named pages)

pages:
  stage: pages
  cache:
    key: 'my-storybook'
    paths:
      - public
  script:
    - if [ "$CI_COMMIT_REF_NAME" = "master" ]; then
      mkdir -p public;
      touch public/index.html;
      echo "<!DOCTYPE HTML><script>window.location.href = 'https://hermosilloi3.gitlab.io/custom-table/main/storybook-static'</script>" > public/index.html;
      fi;
    - rm -rf "public/$CI_COMMIT_REF_SLUG"
    - mkdir -p "public/$CI_COMMIT_REF_SLUG";
    - mv storybook-static "public/$CI_COMMIT_REF_SLUG"
  artifacts:
    paths:
      - public